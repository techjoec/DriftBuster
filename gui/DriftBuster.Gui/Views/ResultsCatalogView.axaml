<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:DriftBuster.Gui.ViewModels"
             xmlns:conv="using:DriftBuster.Gui.Converters"
             x:Class="DriftBuster.Gui.Views.ResultsCatalogView"
             x:DataType="vm:ResultsCatalogViewModel">
  <ScrollViewer>
    <StackPanel Margin="0,0,0,24" Spacing="18">
      <Border Classes="surface" Padding="18" CornerRadius="{DynamicResource Radius.Large}">
        <Grid ColumnDefinitions="*,*,*,*,*" RowDefinitions="Auto,Auto">
          <StackPanel Grid.Column="0" Spacing="4">
            <TextBlock Text="Baseline" Classes="subtitle" />
            <ComboBox ItemsSource="{Binding BaselineOptions}" SelectedItem="{Binding SelectedBaseline}" />
          </StackPanel>
          <StackPanel Grid.Column="1" Spacing="4" Margin="12,0,0,0">
            <TextBlock Text="Coverage" Classes="subtitle" />
            <ComboBox ItemsSource="{Binding CoverageFilterOptions}"
                      SelectedValue="{Binding SelectedCoverageFilter}"
                      SelectedValueBinding="{Binding Value}" />
          </StackPanel>
          <StackPanel Grid.Column="2" Spacing="4" Margin="12,0,0,0">
            <TextBlock Text="Severity" Classes="subtitle" />
            <ComboBox ItemsSource="{Binding SeverityFilterOptions}"
                      SelectedValue="{Binding SelectedSeverityFilter}"
                      SelectedValueBinding="{Binding Value}" />
          </StackPanel>
          <StackPanel Grid.Column="3" Spacing="4" Margin="12,0,0,0">
            <TextBlock Text="Format" Classes="subtitle" />
            <ComboBox ItemsSource="{Binding FormatOptions}" SelectedItem="{Binding SelectedFormat}" />
          </StackPanel>
          <StackPanel Grid.Column="4" Spacing="4" Margin="12,0,0,0">
            <TextBlock Text="Search" Classes="subtitle" />
            <TextBox Text="{Binding SearchText, UpdateSourceTrigger=PropertyChanged}" Watermark="Config name or ID" />
          </StackPanel>
          <TextBlock Grid.Row="1" Grid.ColumnSpan="5"
                     Margin="0,8,0,0"
                     Classes="subtitle"
                     Text="Use filters to focus on the highest-risk configs. Partial coverage cards expose quick actions for missing hosts." />
        </Grid>
      </Border>

      <Border Classes="surface" Padding="18" CornerRadius="{DynamicResource Radius.Large}">
        <StackPanel Spacing="12">
          <TextBlock Text="Configuration catalog" FontSize="18" FontWeight="SemiBold" />
          <DataGrid x:Name="CatalogGrid"
                    ItemsSource="{Binding FilteredEntries}"
                    AutoGenerateColumns="False"
                    IsReadOnly="True"
                    HeadersVisibility="Column"
                    GridLinesVisibility="All"
                    MinHeight="280"
                    Sorting="OnCatalogGridSorting">
            <DataGrid.Columns>
              <DataGridTextColumn Header="Config"
                                  Binding="{Binding DisplayName}"
                                  Width="2*"
                                  SortMemberPath="{x:Static vm:CatalogSortColumns.Config}" />
              <DataGridTextColumn Header="Drift"
                                  Binding="{Binding DriftSummary}"
                                  Width="*"
                                  SortMemberPath="{x:Static vm:CatalogSortColumns.Drift}" />
              <DataGridTextColumn Header="Coverage"
                                  Binding="{Binding CoverageText}"
                                  Width="*"
                                  SortMemberPath="{x:Static vm:CatalogSortColumns.Coverage}" />
              <DataGridTextColumn Header="Format"
                                  Binding="{Binding Format}"
                                  Width="*"
                                  SortMemberPath="{x:Static vm:CatalogSortColumns.Format}" />
              <DataGridTextColumn Header="Severity"
                                  Binding="{Binding Severity}"
                                  Width="*"
                                  SortMemberPath="{x:Static vm:CatalogSortColumns.Severity}" />
              <DataGridTextColumn Header="Updated"
                                  Binding="{Binding LastUpdatedText}"
                                  Width="1.5*"
                                  SortMemberPath="{x:Static vm:CatalogSortColumns.Updated}" />
              <DataGridTemplateColumn Header="Tags" Width="2*">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <WrapPanel>
                      <Border Background="#4C1D95" Padding="6,2" CornerRadius="6" IsVisible="{Binding HasDrift}" Margin="0,0,6,6">
                        <TextBlock Text="Drift" FontSize="12" />
                      </Border>
                      <Border Background="#991B1B" Padding="6,2" CornerRadius="6" IsVisible="{Binding HasSecrets}" Margin="0,0,6,6">
                        <TextBlock Text="Secrets" FontSize="12" />
                      </Border>
                      <Border Background="#9A3412" Padding="6,2" CornerRadius="6" IsVisible="{Binding HasMaskedTokens}" Margin="0,0,6,6">
                        <TextBlock Text="Masked" FontSize="12" />
                      </Border>
                      <Border Background="#92400E" Padding="6,2" CornerRadius="6" IsVisible="{Binding HasValidationIssues}" Margin="0,0,6,6">
                        <TextBlock Text="Validation" FontSize="12" />
                      </Border>
                    </WrapPanel>
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>
              <DataGridTemplateColumn Header="Actions" Width="1.5*">
                <DataGridTemplateColumn.CellTemplate>
                  <DataTemplate>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <Button Content="Drilldown"
                              Classes="outline"
                              Command="{Binding DataContext.DrilldownCommand, RelativeSource={RelativeSource AncestorType=DataGrid}}"
                              CommandParameter="{Binding}" />
                    </StackPanel>
                  </DataTemplate>
                </DataGridTemplateColumn.CellTemplate>
              </DataGridTemplateColumn>
            </DataGrid.Columns>
          </DataGrid>
        </StackPanel>
      </Border>

      <Border Classes="surface" Padding="18" CornerRadius="{DynamicResource Radius.Large}"
              IsVisible="{Binding HasPartialCoverage}">
        <StackPanel Spacing="10">
          <Grid ColumnDefinitions="*,Auto" VerticalAlignment="Center">
            <TextBlock Text="Missing artifacts" FontSize="18" FontWeight="SemiBold" />
            <Button Grid.Column="1"
                    Content="Re-scan all missing"
                    Classes="outline"
                    Command="{Binding ReScanAllPartialCommand}"
                    Margin="12,0,0,0" />
          </Grid>
          <ItemsRepeater x:Name="PartialCoverageVirtualRepeater"
                         ItemsSource="{Binding PartialCoverageEntries}"
                         IsVisible="{Binding UseVirtualizedPartialCoverage}">
            <ItemsRepeater.Layout>
              <StackLayout Orientation="Vertical" Spacing="10" />
            </ItemsRepeater.Layout>
            <ItemsRepeater.ItemTemplate>
              <DataTemplate>
                <Border Padding="12" CornerRadius="{DynamicResource Radius.Medium}" Classes="surface" Margin="0,0,0,10">
                  <StackPanel Spacing="6">
                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding CoverageText}" Classes="subtitle" />
                    <TextBlock Text="{Binding MissingHostsSummary}" Classes="subtitle" />
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <Button Content="Drilldown"
                              Classes="outline"
                              Command="{Binding DataContext.DrilldownCommand, RelativeSource={RelativeSource AncestorType=ItemsRepeater}}"
                              CommandParameter="{Binding}" />
                      <Button Content="Re-scan missing"
                              Classes="outline"
                              Command="{Binding DataContext.ReScanMissingCommand, RelativeSource={RelativeSource AncestorType=ItemsRepeater}}"
                              CommandParameter="{Binding}" />
                    </StackPanel>
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsRepeater.ItemTemplate>
          </ItemsRepeater>
          <ItemsControl x:Name="PartialCoverageFallback"
                        ItemsSource="{Binding PartialCoverageEntries}"
                        IsVisible="{Binding UseVirtualizedPartialCoverage, Converter={x:Static conv:BooleanNegationConverter.Instance}}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Padding="12" CornerRadius="{DynamicResource Radius.Medium}" Classes="surface" Margin="0,0,0,10">
                  <StackPanel Spacing="6">
                    <TextBlock Text="{Binding DisplayName}" FontWeight="SemiBold" />
                    <TextBlock Text="{Binding CoverageText}" Classes="subtitle" />
                    <TextBlock Text="{Binding MissingHostsSummary}" Classes="subtitle" />
                    <StackPanel Orientation="Horizontal" Spacing="8">
                      <Button Content="Drilldown"
                              Classes="outline"
                              Command="{Binding DataContext.DrilldownCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                              CommandParameter="{Binding}" />
                      <Button Content="Re-scan missing"
                              Classes="outline"
                              Command="{Binding DataContext.ReScanMissingCommand, RelativeSource={RelativeSource AncestorType=ItemsControl}}"
                              CommandParameter="{Binding}" />
                    </StackPanel>
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>
        </StackPanel>
      </Border>
    </StackPanel>
  </ScrollViewer>
</UserControl>
