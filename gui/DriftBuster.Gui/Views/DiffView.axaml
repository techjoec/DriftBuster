<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:automation="using:Avalonia.Automation"
             xmlns:conv="using:DriftBuster.Gui.Converters"
             xmlns:vm="using:DriftBuster.Gui.ViewModels"
             x:Class="DriftBuster.Gui.Views.DiffView"
             x:DataType="vm:DiffViewModel">
  <ScrollViewer>
    <StackPanel Spacing="24">
      <StackPanel Spacing="6">
        <TextBlock Classes="heading" Text="Diff planner" />
        <TextBlock Classes="subtitle"
                   Text="Compare multiple snapshots, capture plan metadata, and export raw JSON." />
      </StackPanel>

      <Border Classes="surface" Padding="24" CornerRadius="{DynamicResource Radius.Large}">
        <StackPanel Spacing="18">
          <StackPanel Orientation="Horizontal"
                      Spacing="12"
                      VerticalAlignment="Center"
                      IsVisible="{Binding HasMruEntries}">
            <TextBlock Text="Recent plans"
                       FontWeight="SemiBold"
                       VerticalAlignment="Center" />
            <ComboBox Width="360"
                      ItemsSource="{Binding MruEntries}"
                      SelectedItem="{Binding SelectedMruEntry, Mode=TwoWay}"
                      PlaceholderText="Select a previous diff"
                      automation:AutomationProperties.AutomationId="DiffPlanner.MruSelector"
                      automation:AutomationProperties.Name="Recent diff planner entries">
              <ComboBox.ItemTemplate>
                <DataTemplate x:DataType="vm:DiffViewModel+DiffPlannerMruEntryView">
                  <StackPanel Orientation="Horizontal" Spacing="8">
                    <TextBlock Text="{Binding DisplayName}" />
                    <TextBlock Text="{Binding PayloadKind}"
                               Classes="subtitle" />
                  </StackPanel>
                </DataTemplate>
              </ComboBox.ItemTemplate>
            </ComboBox>
          </StackPanel>

          <ItemsControl ItemsSource="{Binding Inputs}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Classes="surface" Padding="16" Margin="0,0,0,12" CornerRadius="{DynamicResource Radius.Medium}">
                  <StackPanel Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                      <RadioButton Content="Baseline"
                                   IsChecked="{Binding IsBaseline, Mode=TwoWay}"
                                   GroupName="BaselineGroup" />
                      <TextBlock Text="Active baseline"
                                 Foreground="{DynamicResource Brush.TextSecondary}"
                                 IsVisible="{Binding IsBaseline}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="10">
                      <TextBox Width="420"
                               Watermark="Select snapshot"
                               Text="{Binding Path, Mode=TwoWay}" />
                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Browse" Classes="outline"
                                Tag="{Binding}"
                                Click="OnBrowseFile" />
                        <Button Content="Remove" Classes="outline"
                                Command="{Binding DataContext.RemoveVersionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}" />
                      </StackPanel>
                    </StackPanel>
                    <TextBlock Text="{Binding Error}"
                               Foreground="{DynamicResource Brush.Accent}"
                               FontSize="12"
                               IsVisible="{Binding Error, Converter={x:Static conv:StringNotEmptyConverter.Instance}}" />
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <Button Content="Add version" Classes="outline"
                  HorizontalAlignment="Left"
                  Command="{Binding AddVersionCommand}" />

          <StackPanel Orientation="Horizontal" Spacing="16">
            <Button Content="Build plan" Classes="primary"
                    Command="{Binding RunDiffCommand}" />
            <ProgressBar Width="160"
                         IsVisible="{Binding IsBusy}"
                         IsIndeterminate="True" />
          </StackPanel>

          <Border Background="#30162128"
                  CornerRadius="{DynamicResource Radius.Medium}"
                  Padding="14"
                  IsVisible="{Binding HasError}">
            <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
              <TextBlock Text="âš "
                         FontSize="16"
                         VerticalAlignment="Center" />
              <TextBlock Text="{Binding ErrorMessage}" FontSize="13" />
            </StackPanel>
          </Border>
        </StackPanel>
      </Border>

      <Border Classes="surface" Padding="24" CornerRadius="{DynamicResource Radius.Large}">
        <StackPanel Spacing="18">
          <StackPanel>
            <TextBlock Text="Plan output" FontSize="18" FontWeight="SemiBold" />
            <TextBlock Classes="subtitle"
                       Text="Preview generated diff plans for each comparison." />
          </StackPanel>

          <StackPanel Orientation="Horizontal"
                      HorizontalAlignment="Right"
                      Spacing="8"
                      IsVisible="{Binding HasAnyJson}">
            <ItemsControl x:Name="JsonViewToggleList"
                          ItemsSource="{Binding JsonViewOptions}">
              <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                  <StackPanel Orientation="Horizontal" Spacing="6" />
                </ItemsPanelTemplate>
              </ItemsControl.ItemsPanel>
              <ItemsControl.ItemTemplate>
                <DataTemplate x:DataType="vm:DiffViewModel+JsonViewOption">
                  <ToggleButton Classes="outline"
                                MinWidth="96"
                                Padding="6,4"
                                Tag="{Binding Mode}"
                                Content="{Binding DisplayName}"
                                Command="{Binding DataContext.SelectJsonViewModeCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding Mode}"
                                automation:AutomationProperties.AutomationId="{Binding Mode}"
                                automation:AutomationProperties.Name="{Binding DisplayName}">
                    <ToggleButton.IsChecked>
                      <MultiBinding Converter="{x:Static conv:DiffJsonViewModeMatchConverter.Instance}">
                        <Binding Path="Mode" />
                        <Binding Path="DataContext.JsonViewMode" RelativeSource="{RelativeSource AncestorType=UserControl}" />
                      </MultiBinding>
                    </ToggleButton.IsChecked>
                  </ToggleButton>
                </DataTemplate>
              </ItemsControl.ItemTemplate>
            </ItemsControl>
            <Button Classes="outline"
                    Content="Copy JSON"
                    Click="OnCopyActiveJson"
                    IsEnabled="{Binding CanCopyActiveJson}"
                    automation:AutomationProperties.AutomationId="DiffPlanner.CopyJsonButton"
                    automation:AutomationProperties.Name="Copy active diff JSON" />
          </StackPanel>

          <ItemsControl ItemsSource="{Binding Comparisons}" IsVisible="{Binding HasResult}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border BorderBrush="{DynamicResource Brush.Border}"
                        BorderThickness="{DynamicResource Thickness.Border}"
                        CornerRadius="{DynamicResource Radius.Large}"
                        Padding="18"
                        Margin="0,0,0,16"
                        Background="{DynamicResource Brush.SurfaceAlt}">
                  <StackPanel Spacing="14">
                    <TextBlock Text="{Binding Title}" FontSize="16" FontWeight="SemiBold" />

                    <ItemsControl ItemsSource="{Binding PlanEntries}">
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <WrapPanel />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Border Classes="surface" Padding="12" Margin="0,0,12,12" CornerRadius="{DynamicResource Radius.Medium}">
                            <StackPanel Spacing="4">
                              <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                              <TextBlock Text="{Binding Value}" Classes="subtitle" TextWrapping="Wrap" />
                            </StackPanel>
                          </Border>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <ItemsControl ItemsSource="{Binding MetadataEntries}">
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <WrapPanel />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Border Background="{DynamicResource Brush.SurfaceMuted}"
                                  BorderBrush="{DynamicResource Brush.Border}"
                                  BorderThickness="{DynamicResource Thickness.Border}"
                                  CornerRadius="{DynamicResource Radius.Medium}"
                                  Padding="12"
                                  Margin="0,0,12,12">
                            <StackPanel Spacing="4">
                              <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                              <TextBlock Text="{Binding Value}" Classes="subtitle" TextWrapping="Wrap" />
                            </StackPanel>
                          </Border>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <TextBlock Text="Select files and build the plan to populate comparison cards."
                     Classes="subtitle"
                     HorizontalAlignment="Center"
                     IsVisible="{Binding ShouldShowPlanHint}" />

          <Border x:Name="SanitizedJsonPane"
                  Background="{DynamicResource Brush.SurfaceAlt}"
                  Padding="16"
                  CornerRadius="{DynamicResource Radius.Medium}"
                  IsVisible="{Binding IsSanitizedViewActive}"
                  automation:AutomationProperties.AutomationId="DiffPlanner.JsonPane.Sanitized"
                  automation:AutomationProperties.Name="Sanitized diff JSON">
            <ScrollViewer Height="160">
              <TextBlock Text="{Binding SanitizedJson}"
                         FontFamily="Consolas"
                         TextWrapping="Wrap" />
            </ScrollViewer>
          </Border>

          <Border x:Name="RawJsonPane"
                  Background="{DynamicResource Brush.SurfaceAlt}"
                  Padding="16"
                  CornerRadius="{DynamicResource Radius.Medium}"
                  IsVisible="{Binding IsRawViewActive}"
                  automation:AutomationProperties.AutomationId="DiffPlanner.JsonPane.Raw"
                  automation:AutomationProperties.Name="Raw diff JSON">
            <ScrollViewer Height="160">
              <TextBlock Text="{Binding RawJson}"
                         FontFamily="Consolas"
                         TextWrapping="Wrap" />
            </ScrollViewer>
          </Border>
        </StackPanel>
      </Border>
    </StackPanel>
  </ScrollViewer>
</UserControl>
