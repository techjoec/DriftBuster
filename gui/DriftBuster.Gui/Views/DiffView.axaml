<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:conv="using:DriftBuster.Gui.Converters"
             xmlns:vm="using:DriftBuster.Gui.ViewModels"
             x:Class="DriftBuster.Gui.Views.DiffView"
             x:DataType="vm:DiffViewModel">
  <ScrollViewer>
    <StackPanel Spacing="24">
      <StackPanel Spacing="6">
        <TextBlock Classes="heading" Text="Diff planner" />
        <TextBlock Classes="subtitle"
                   Text="Compare multiple snapshots, capture plan metadata, and export raw JSON." />
      </StackPanel>

      <Border Classes="surface" Padding="24" CornerRadius="{DynamicResource Radius.Large}">
        <StackPanel Spacing="18">
          <ItemsControl ItemsSource="{Binding Inputs}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border Classes="surface" Padding="16" Margin="0,0,0,12" CornerRadius="{DynamicResource Radius.Medium}">
                  <StackPanel Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                      <RadioButton Content="Baseline"
                                   IsChecked="{Binding IsBaseline, Mode=TwoWay}"
                                   GroupName="BaselineGroup" />
                      <TextBlock Text="Active baseline"
                                 Foreground="{DynamicResource Brush.TextSecondary}"
                                 IsVisible="{Binding IsBaseline}" />
                    </StackPanel>
                    <StackPanel Orientation="Horizontal" Spacing="10">
                      <TextBox Width="420"
                               Watermark="Select snapshot"
                               Text="{Binding Path, Mode=TwoWay}" />
                      <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Browse"
                                Tag="{Binding}"
                                Click="OnBrowseFile" />
                        <Button Content="Remove"
                                Command="{Binding DataContext.RemoveVersionCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                CommandParameter="{Binding}" />
                      </StackPanel>
                    </StackPanel>
                    <TextBlock Text="{Binding Error}"
                               Foreground="{DynamicResource Brush.Accent}"
                               FontSize="12"
                               IsVisible="{Binding Error, Converter={x:Static conv:StringNotEmptyConverter.Instance}}" />
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <Button Content="Add version"
                  HorizontalAlignment="Left"
                  Command="{Binding AddVersionCommand}" />

          <StackPanel Orientation="Horizontal" Spacing="16">
            <Button Content="Build plan"
                    Command="{Binding RunDiffCommand}" />
            <ProgressBar Width="160"
                         IsVisible="{Binding IsBusy}"
                         IsIndeterminate="True" />
          </StackPanel>

          <Border Background="#30162128"
                  CornerRadius="{DynamicResource Radius.Medium}"
                  Padding="14"
                  IsVisible="{Binding HasError}">
            <StackPanel Orientation="Horizontal" Spacing="10" VerticalAlignment="Center">
              <TextBlock Text="âš "
                         FontSize="16"
                         VerticalAlignment="Center" />
              <TextBlock Text="{Binding ErrorMessage}" FontSize="13" />
            </StackPanel>
          </Border>
        </StackPanel>
      </Border>

      <Border Classes="surface" Padding="24" CornerRadius="{DynamicResource Radius.Large}">
        <StackPanel Spacing="18">
          <StackPanel>
            <TextBlock Text="Plan output" FontSize="18" FontWeight="SemiBold" />
            <TextBlock Classes="subtitle"
                       Text="Preview generated diff plans for each comparison." />
          </StackPanel>

          <Button Content="Copy raw JSON"
                  HorizontalAlignment="Right"
                  IsEnabled="{Binding HasRawJson}"
                  IsVisible="{Binding HasRawJson}"
                  Click="OnCopyRawJson" />

          <ItemsControl ItemsSource="{Binding Comparisons}" IsVisible="{Binding HasResult}">
            <ItemsControl.ItemTemplate>
              <DataTemplate>
                <Border BorderBrush="{DynamicResource Brush.Border}"
                        BorderThickness="{DynamicResource Thickness.Border}"
                        CornerRadius="{DynamicResource Radius.Large}"
                        Padding="18"
                        Margin="0,0,0,16"
                        Background="{DynamicResource Brush.SurfaceAlt}">
                  <StackPanel Spacing="14">
                    <TextBlock Text="{Binding Title}" FontSize="16" FontWeight="SemiBold" />

                    <ItemsControl ItemsSource="{Binding PlanEntries}">
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <WrapPanel />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Border Classes="surface" Padding="12" Margin="0,0,12,12" CornerRadius="{DynamicResource Radius.Medium}">
                            <StackPanel Spacing="4">
                              <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                              <TextBlock Text="{Binding Value}" Classes="subtitle" TextWrapping="Wrap" />
                            </StackPanel>
                          </Border>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>

                    <ItemsControl ItemsSource="{Binding MetadataEntries}">
                      <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                          <WrapPanel />
                        </ItemsPanelTemplate>
                      </ItemsControl.ItemsPanel>
                      <ItemsControl.ItemTemplate>
                        <DataTemplate>
                          <Border Background="{DynamicResource Brush.SurfaceMuted}"
                                  BorderBrush="{DynamicResource Brush.Border}"
                                  BorderThickness="{DynamicResource Thickness.Border}"
                                  CornerRadius="{DynamicResource Radius.Medium}"
                                  Padding="12"
                                  Margin="0,0,12,12">
                            <StackPanel Spacing="4">
                              <TextBlock Text="{Binding Name}" FontWeight="SemiBold" />
                              <TextBlock Text="{Binding Value}" Classes="subtitle" TextWrapping="Wrap" />
                            </StackPanel>
                          </Border>
                        </DataTemplate>
                      </ItemsControl.ItemTemplate>
                    </ItemsControl>
                  </StackPanel>
                </Border>
              </DataTemplate>
            </ItemsControl.ItemTemplate>
          </ItemsControl>

          <TextBlock Text="Select files and build the plan to populate comparison cards."
                     Classes="subtitle"
                     HorizontalAlignment="Center"
                     IsVisible="{Binding ShouldShowPlanHint}" />

          <Expander Header="Raw JSON" IsExpanded="False" IsVisible="{Binding HasRawJson}">
            <Border Background="{DynamicResource Brush.SurfaceAlt}" Padding="16" CornerRadius="{DynamicResource Radius.Medium}">
              <ScrollViewer Height="160">
                <TextBlock Text="{Binding RawJson}"
                           FontFamily="Consolas"
                           TextWrapping="Wrap" />
              </ScrollViewer>
            </Border>
          </Expander>
        </StackPanel>
      </Border>
    </StackPanel>
  </ScrollViewer>
</UserControl>
